<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Kelola Cerita</title>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>
  <header>Admin Kelola Cerita</header>

  <!-- Form PIN -->
  <div id="pin-form">
    <label for="pin">Masukkan PIN:</label>
    <input type="password" id="pin" required />
    <button id="submit-pin">Masuk</button>
  </div>

  <!-- Konten Admin -->
  <main id="admin-content" style="display: none;">
    <form id="form-cerita">
      <input type="hidden" id="current-key" />
      <label for="judul">Judul Cerita</label>
      <input type="text" id="judul" required />

      <label for="genre">Genre</label>
      <input type="text" id="genre" required />

      <label for="isi">Isi Cerita</label>
      <textarea id="isi" required></textarea>

      <label for="gambar">Cover Cerita (gambar URL atau file)</label>
      <input type="file" id="gambar" accept="image/*" />

      <button type="submit">Simpan Cerita</button>
    </form>

    <input type="text" id="search" placeholder="Cari judul atau genre" />
    <div class="cerita-list" id="cerita-list"></div>
  </main>

  <footer>
    &copy; 2025 Admin Cerita Digital | <a href="#">Kebijakan</a> | <a href="#">Kontak</a>
  </footer>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDeiLybtGc6evATj5O7M1FiJd1GPYd-rYc",
      authDomain: "tamplatedoc.firebaseapp.com",
      databaseURL: "https://tamplatedoc-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tamplatedoc",
      storageBucket: "tamplatedoc.appspot.com",
      messagingSenderId: "264966107720",
      appId: "1:264966107720:web:868abe93cdff209040de7d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const form = document.getElementById('form-cerita');
    const currentKeyInput = document.getElementById('current-key');
    const judul = document.getElementById('judul');
    const genre = document.getElementById('genre');
    const isi = document.getElementById('isi');
    const gambar = document.getElementById('gambar');
    const ceritaList = document.getElementById('cerita-list');
    const pinForm = document.getElementById('pin-form');
    const adminContent = document.getElementById('admin-content');
    const pinInput = document.getElementById('pin');
    const submitPinButton = document.getElementById('submit-pin');

    submitPinButton.addEventListener('click', () => {
      const enteredPin = pinInput.value;
      auth.signInAnonymously()
        .then(() => {
          db.ref("admin_pin").once("value").then(snapshot => {
            const correctPin = snapshot.val();
            if (enteredPin === correctPin) {
              pinForm.style.display = 'none';
              adminContent.style.display = 'block';
              loadCerita();
            } else {
              alert("PIN salah");
              auth.signOut();
            }
          });
        })
        .catch(err => {
          alert("Gagal autentikasi");
        });
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      let gambarData = '';

      if (gambar.files.length > 0) {
        const file = gambar.files[0];
        if (file.size > 2 * 1024 * 1024) {
          alert('Gambar maksimal 2MB');
          return;
        }
        gambarData = await fileToBase64(file);
      }

      const data = {
        judul: judul.value.trim(),
        genre: genre.value.trim(),
        isi: isi.value.trim(),
        gambar: gambarData,
        createdAt: firebase.database.ServerValue.TIMESTAMP
      };

      const key = currentKeyInput.value;
      if (key) {
        db.ref(`cerita/${key}`).set(data).then(() => {
          alert('Cerita diperbarui!');
          resetForm();
        });
      } else {
        db.ref('cerita').push(data).then(() => {
          alert('Cerita ditambahkan!');
          resetForm();
        });
      }
    });

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject('Gagal membaca file');
        reader.readAsDataURL(file);
      });
    }

    function resetForm() {
      form.reset();
      currentKeyInput.value = '';
    }

    function loadCerita() {
      db.ref('cerita').on('value', (snapshot) => {
        const data = snapshot.val() || {};
        ceritaList.innerHTML = '';
        Object.entries(data).forEach(([key, val]) => {
          const item = document.createElement('div');
          item.innerHTML = `
            <h3>${val.judul}</h3>
            <div><strong>Genre:</strong> ${val.genre}</div>
            <div>
              <button class="btn-edit" data-key="${key}">Edit</button>
              <button class="btn-delete" data-key="${key}">Hapus</button>
            </div>
            <hr/>
          `;
          ceritaList.appendChild(item);
        });

        document.querySelectorAll('.btn-edit').forEach(btn => {
          btn.onclick = () => {
            editCerita(btn.dataset.key);
            window.scrollTo(0, 0);
          };
        });
        document.querySelectorAll('.btn-delete').forEach(btn => {
          btn.onclick = () => hapusCerita(btn.dataset.key);
        });
      });
    }

    function editCerita(key) {
      db.ref(`cerita/${key}`).once('value').then(snapshot => {
        const data = snapshot.val();
        if (data) {
          judul.value = data.judul;
          genre.value = data.genre;
          isi.value = data.isi;
          currentKeyInput.value = key;
        }
      });
    }

    function hapusCerita(key) {
      if (confirm('Yakin ingin menghapus cerita ini?')) {
        db.ref(`cerita/${key}`).remove().then(() => {
          alert('Cerita dihapus');
          resetForm();
        });
      }
    }

    document.getElementById('search').addEventListener('input', function () {
      const searchTerm = this.value.toLowerCase();
      const items = document.querySelectorAll('.cerita-list > div');
      items.forEach(item => {
        const title = item.querySelector('h3').textContent.toLowerCase();
        const genreText = item.querySelector('div').textContent.toLowerCase();
        item.style.display = (title.includes(searchTerm) || genreText.includes(searchTerm)) ? '' : 'none';
      });
    });
  </script>
</body>
</html>
