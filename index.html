<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AMDF.GROUP - Creator Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <style>
    /* CSS sama seperti sebelumnya */
    :root {
      --background-start: #f0f2f5;
      --background-end: #e0e2e5;
      --text-color: #333;
      /* ... (variabel CSS lainnya) ... */
    }
    /* ... (CSS lengkap seperti sebelumnya) ... */
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <a href="catalog.html" class="logo">AMDF.GROUP</a>
    <div style="display: flex; align-items: center;">
      <a href="catalog.html" class="btn-back"><i class="fas fa-arrow-left"></i> Back to Catalog</a>
      <div class="mode-toggle" onclick="toggleDarkMode()">
        <div class="circle"></div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main>
    <section class="auth-container">
      <h2 id="authTitle">Login as Creator</h2>
      <div id="message" class="message" style="display:none;"></div>

      <!-- Login Form -->
      <form id="loginForm">
        <div class="form-group">
          <label for="loginEmail">Email Address</label>
          <input type="email" id="loginEmail" placeholder="your.email@example.com" required>
        </div>
        <div class="g-recaptcha" data-sitekey="6LeLlYArAAAAAOpJ7LHBYPS7xU1RLfQHuDd8jynh" data-callback="onLoginRecaptchaSuccess"></div>
        <button type="submit" id="loginSubmitBtn" disabled>Send Magic Link</button>
      </form>

      <!-- Register Form -->
      <form id="registerForm" style="display:none;">
        <div class="form-group">
          <label for="registerEmail">Email Address</label>
          <input type="email" id="registerEmail" placeholder="your.email@example.com" required>
        </div>
        <div class="form-group">
          <label for="registerAuthorName">Author Name</label>
          <input type="text" id="registerAuthorName" placeholder="Your Pen Name" required>
        </div>
        <div class="form-group">
          <label for="registerWhatsapp">WhatsApp Number</label>
          <input type="tel" id="registerWhatsapp" placeholder="+628123456789" required>
        </div>
        <div class="g-recaptcha" data-sitekey="6LeLlYArAAAAAOpJ7LHBYPS7xU1RLfQHuDd8jynh" data-callback="onRegisterRecaptchaSuccess"></div>
        <button type="submit" id="registerSubmitBtn" disabled>Register and Send Magic Link</button>
      </form>

      <div class="auth-toggle">
        <span id="toggleText">Don't have an account?</span>
        <a href="#" id="toggleAuth">Register here</a>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 AMDF.GROUP. All rights reserved.</p>
    <nav>
      <a href="#about">About Us</a> |
      <a href="#privacy">Privacy Policy</a> |
      <a href="#terms">Terms of Service</a>
    </nav>
  </footer>

  <!-- Firebase & App Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { 
      getAuth, 
      isSignInWithEmailLink, 
      signInWithEmailLink, 
      sendSignInLinkToEmail,
      signInAnonymously
    } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import { 
      getFunctions, 
      httpsCallable 
    } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-functions.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDeiLybtGc6evATj5O7M1FiJd1GPYd-rYc",
      authDomain: "tamplatedoc.firebaseapp.com",
      projectId: "tamplatedoc",
      storageBucket: "tamplatedoc.firebasestorage.app",
      messagingSenderId: "264966107720",
      appId: "1:264966107720:web:868abe93cdff209040de7d"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const functions = getFunctions(app);
    const verifyRecaptcha = httpsCallable(functions, 'verifyRecaptcha');

    // Global Variables
    let currentRecaptchaToken = '';
    const actionCodeSettings = {
      url: window.location.href,
      handleCodeInApp: true
    };

    // DOM Elements
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const loginSubmitBtn = document.getElementById('loginSubmitBtn');
    const registerSubmitBtn = document.getElementById('registerSubmitBtn');
    const messageDiv = document.getElementById('message');

    // Initialize Anonymous Auth
    signInAnonymously(auth).catch(error => {
      console.log("Anonymous auth failed (non-critical):", error);
    });

    // reCAPTCHA Callbacks
    window.onLoginRecaptchaSuccess = (token) => {
      currentRecaptchaToken = token;
      loginSubmitBtn.disabled = false;
    };

    window.onRegisterRecaptchaSuccess = (token) => {
      currentRecaptchaToken = token;
      registerSubmitBtn.disabled = false;
    };

    window.onRecaptchaExpired = () => {
      currentRecaptchaToken = '';
      loginSubmitBtn.disabled = true;
      registerSubmitBtn.disabled = true;
      showMessage("reCAPTCHA expired. Please verify again.", "error");
    };

    // Form Handlers
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      await handleAuthFlow('login');
    });

    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      await handleAuthFlow('register');
    });

    // Auth Flow
    async function handleAuthFlow(type) {
      const email = document.getElementById(`${type}Email`).value.trim();
      
      try {
        // Verify reCAPTCHA first
        const recaptchaResult = await verifyRecaptcha({ 
          token: currentRecaptchaToken 
        });
        
        if (!recaptchaResult.data.success) {
          throw new Error("reCAPTCHA verification failed");
        }

        // Send magic link
        await sendSignInLinkToEmail(auth, email, actionCodeSettings);
        localStorage.setItem('emailForSignIn', email);
        
        if (type === 'register') {
          // Save additional data (implement sesuai kebutuhan)
          console.log("Registration data:", {
            name: document.getElementById('registerAuthorName').value,
            whatsapp: document.getElementById('registerWhatsapp').value
          });
        }

        showMessage(`Magic link sent to ${email}. Check your inbox!`, "success");
        resetForms();
      } catch (error) {
        showMessage(error.message || "Authentication failed", "error");
        resetRecaptcha();
      }
    }

    // Helper Functions
    function showMessage(text, type) {
      messageDiv.textContent = text;
      messageDiv.className = `message ${type}`;
      messageDiv.style.display = 'block';
    }

    function resetForms() {
      loginForm.reset();
      registerForm.reset();
      resetRecaptcha();
    }

    function resetRecaptcha() {
      currentRecaptchaToken = '';
      if (typeof grecaptcha !== 'undefined') {
        grecaptcha.reset();
      }
      loginSubmitBtn.disabled = true;
      registerSubmitBtn.disabled = true;
    }

    // Handle email link sign-in
    if (isSignInWithEmailLink(auth, window.location.href)) {
      const email = localStorage.getItem('emailForSignIn') || 
                   prompt("Please enter your email for confirmation:");
      
      if (email) {
        signInWithEmailLink(auth, email, window.location.href)
          .then(() => {
            localStorage.removeItem('emailForSignIn');
            window.location.href = 'creator-dashboard.html';
          })
          .catch(error => {
            showMessage("Login failed: " + error.message, "error");
          });
      }
    }
  </script>
</body>
</html>
